name: Release Stencil Storybook Plugin

on:
  workflow_dispatch:
    inputs:
      releaseType:
        description: 'Release type - major, minor or patch'
        required: true
        type: choice
        default: 'patch'
        options:
          - patch
          - minor
          - major
      devRelease:
        description: Set to "yes" to release a dev build
        required: true
        type: choice
        default: 'no'
        options:
          - 'yes'
          - 'no'

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Detect pnpm and generate fallback package-lock.json for CI
        run: |
          # If this repo uses pnpm (pnpm-lock.yaml) but no package-lock.json or yarn.lock
          # create a minimal package-lock.json so existing CI steps that only look for
          # package-lock.json / yarn.lock do not fail. This does not change the repo.
          if [ -f pnpm-lock.yaml ] && [ ! -f package-lock.json ] && [ ! -f yarn.lock ]; then
            echo "pnpm-lock.yaml found â€” creating fallback package-lock.json for CI compatibility"
            # npm init may be required to ensure package.json metadata for package-lock generation
            npm init -y >/dev/null 2>&1 || true
            npm install --package-lock-only >/dev/null 2>&1 || true
          else
            echo "No pnpm-only repo detected or lockfile already present â€” nothing to do"
          fi
        shell: bash

      - name: ðŸ—ï¸ Setup and Build
        uses: ./.github/actions/build

      - name: ðŸ“¦ Upload Build Artifacts
        uses: stenciljs/.github/actions/upload-archive@main
        with:
          paths: packages/plugin/dist

  get_dev_version:
    if: inputs.devRelease == 'yes'
    name: Get Dev Build Version
    runs-on: ubuntu-latest
    outputs:
      dev-version: ${{ steps.generate-dev-version.outputs.DEV_VERSION }}
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Detect pnpm and generate fallback package-lock.json for CI
        run: |
          if [ -f pnpm-lock.yaml ] && [ ! -f package-lock.json ] && [ ! -f yarn.lock ]; then
            echo "pnpm-lock.yaml found â€” creating fallback package-lock.json for CI compatibility"
            npm init -y >/dev/null 2>&1 || true
            npm install --package-lock-only >/dev/null 2>&1 || true
          else
            echo "No pnpm-only repo detected or lockfile already present â€” nothing to do"
          fi
        shell: bash

      - name: ðŸš€ Generate Dev Version
        id: generate-dev-version
        working-directory: packages/plugin
        run: |
          PKG_JSON_VERSION=$(cat package.json | jq -r '.version')
          GIT_HASH=$(git rev-parse --short HEAD)

          # A unique string to publish Stencil Storybook Plugin under
          # e.g. "2.1.0-dev.1677185104.7c87e34"
          DEV_VERSION=$PKG_JSON_VERSION-dev.$(date +"%s").$GIT_HASH

          echo "Using version $DEV_VERSION"

          # store a key/value pair in GITHUB_OUTPUT
          # e.g. "DEV_VERSION=2.1.0-dev.1677185104.7c87e34"
          echo "DEV_VERSION=$DEV_VERSION" >> $GITHUB_OUTPUT
        shell: bash

  release_storybook_stencil:
    if: inputs.devRelease == 'yes'
    name: Publish Dev Build
    needs: [build, get_dev_version]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Detect pnpm and generate fallback package-lock.json for CI
        run: |
          if [ -f pnpm-lock.yaml ] && [ ! -f package-lock.json ] && [ ! -f yarn.lock ]; then
            echo "pnpm-lock.yaml found â€” creating fallback package-lock.json for CI compatibility"
            npm init -y >/dev/null 2>&1 || true
            npm install --package-lock-only >/dev/null 2>&1 || true
          else
            echo "No pnpm-only repo detected or lockfile already present â€” nothing to do"
          fi
        shell: bash

      - name: ðŸ“¥ Download Build Archive
        uses: stenciljs/.github/actions/download-archive@main
        with:
          path: packages/plugin

      - name: ðŸ“‹ Generate package-lock.json for plugin
        working-directory: packages/plugin
        run: npm install --package-lock-only
        shell: bash

      - name: ðŸ“¦ Publish NPM
        uses: stenciljs/.github/actions/publish-npm@e9945bdf51e97eee158513427ecf7be3d3a80443 # temp fix for trusted publishers
        with:
          tag: dev
          working-directory: packages/plugin
          version: ${{ needs.get_dev_version.outputs.dev-version }}

  release_create_stencil_cli:
    if: inputs.devRelease == 'no'
    name: Publish Stencil Storybook Plugin
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Detect pnpm and generate fallback package-lock.json for CI
        run: |
          if [ -f pnpm-lock.yaml ] && [ ! -f package-lock.json ] && [ ! -f yarn.lock ]; then
            echo "pnpm-lock.yaml found â€” creating fallback package-lock.json for CI compatibility"
            npm init -y >/dev/null 2>&1 || true
            npm install --package-lock-only >/dev/null 2>&1 || true
          else
            echo "No pnpm-only repo detected or lockfile already present â€” nothing to do"
          fi
        shell: bash

      - name: ðŸ“¥ Download Build Archive
        uses: stenciljs/.github/actions/download-archive@main
        with:
          path: packages/plugin

      - name: ðŸ“‹ Generate package-lock.json for plugin
        working-directory: packages/plugin
        run: npm install --package-lock-only
        shell: bash

      - name: ðŸ“¦ Publish NPM
        uses: stenciljs/.github/actions/publish-npm@e9945bdf51e97eee158513427ecf7be3d3a80443 # temp fix for trusted publishers
        with:
          tag: latest
          working-directory: packages/plugin
          version: ${{ inputs.releaseType }}
